# 리뷰 관리 유스케이스 명세서

## 문서 정보

- **버전**: 1.0.0
- **최종 수정일**: 2025-10-21
- **작성자**: Development Team
- **문서 상태**: Draft
- **참조 문서**:
  - [사용자 플로우](/docs/userflow.md)
  - [PRD](/docs/prd.md)

---

## 개요

이 문서는 맛집 지도 서비스의 리뷰 관리 기능에 대한 상세 유스케이스를 정의합니다. 리뷰 관리는 비로그인 사용자가 비밀번호 기반으로 리뷰를 작성, 조회, 수정, 삭제할 수 있는 핵심 기능입니다.

---

## 유스케이스 목록

1. [UC-001: 리뷰 작성](#uc-001-리뷰-작성)
2. [UC-002: 리뷰 목록 조회](#uc-002-리뷰-목록-조회)
3. [UC-003: 리뷰 수정](#uc-003-리뷰-수정)
4. [UC-004: 리뷰 삭제](#uc-004-리뷰-삭제)

---

## UC-001: 리뷰 작성

### 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **ID** | UC-001 |
| **이름** | 리뷰 작성 |
| **우선순위** | P0 (Must Have) |
| **액터** | 일반 사용자 (비로그인) |
| **목적** | 방문한 맛집에 대한 경험을 공유하기 위해 리뷰를 작성한다 |

### 사전 조건

- 사용자가 리뷰를 작성할 장소를 선택한 상태여야 한다
- 네트워크 연결이 정상적으로 동작해야 한다
- 장소 정보(장소명, 주소, 좌표 등)가 확인 가능한 상태여야 한다

### 사후 조건

- 새로운 리뷰가 데이터베이스에 저장된다
- 장소의 평균 평점과 리뷰 수가 자동으로 갱신된다
- 해당 장소의 리뷰가 첫 번째인 경우, 지도에 새로운 마커가 표시된다
- 사용자는 장소 상세 페이지로 리다이렉트된다
- 작성된 리뷰가 목록의 최상단에 표시된다

### 기본 플로우

1. **리뷰 작성 페이지 진입**
   - 사용자가 장소 상세 페이지에서 "리뷰 작성" 버튼을 클릭한다
   - 시스템이 리뷰 작성 페이지(`/place/[placeId]/review/new`)로 이동한다
   - 시스템이 장소 ID로 장소 정보를 조회한다
   - 시스템이 장소 정보 요약을 고정 헤더에 표시한다 (장소명, 주소)

2. **리뷰 정보 입력**
   - 사용자가 다음 필수 정보를 입력한다:
     - 작성자명 (2-10자)
     - 평점 (별점 1-5)
     - 리뷰 내용 (10-500자)
     - 비밀번호 (4-20자, 수정/삭제 시 사용)
   - 사용자가 선택적으로 방문 날짜를 입력한다
   - 시스템이 실시간으로 입력값 유효성을 검증한다
   - 유효성 검증 실패 시, 해당 필드 하단에 빨간색 에러 메시지를 표시한다

3. **리뷰 제출**
   - 사용자가 "작성하기" 버튼을 클릭한다
   - 시스템이 클라이언트 측 유효성 검증을 수행한다
   - 유효성 검증 통과 시, 버튼이 비활성화되고 "작성 중..." 로딩 상태로 변경된다

4. **서버 처리**
   - 시스템이 리뷰 작성 API(`POST /api/places/:placeId/reviews`)를 호출한다
   - 서버가 서버 측 유효성 검증을 수행한다
   - 서버가 XSS 방지를 위해 입력값을 sanitize 처리한다
   - 서버가 비밀번호를 bcrypt로 해싱한다 (salt rounds: 10)
   - 서버가 리뷰를 데이터베이스에 저장한다
   - 서버가 데이터베이스 트리거를 통해 장소의 평균 평점과 리뷰 수를 자동 갱신한다

5. **결과 표시**
   - 시스템이 성공 토스트 메시지를 표시한다: "리뷰가 작성되었습니다"
   - 시스템이 장소 상세 페이지로 리다이렉트한다
   - 시스템이 새로 작성된 리뷰를 목록의 최상단에 표시한다
   - 첫 번째 리뷰인 경우, 지도에 해당 장소의 마커가 자동으로 표시된다

### 대체 플로우

#### AF-001: 장소가 데이터베이스에 없는 경우

- **분기점**: 기본 플로우 4단계
- **조건**: 리뷰를 작성하려는 장소가 데이터베이스에 존재하지 않는 경우
- **플로우**:
  1. 서버가 네이버 로컬 검색 API를 호출하여 장소 정보를 조회한다
  2. 서버가 장소 정보(장소명, 주소, 카테고리, 좌표, 전화번호 등)를 데이터베이스에 저장한다
  3. 서버가 리뷰를 새로 생성된 장소에 연결하여 저장한다
  4. 기본 플로우 5단계로 복귀한다

#### AF-002: 입력값 실시간 검증

- **분기점**: 기본 플로우 2단계
- **조건**: 사용자가 필드에 값을 입력하는 동안
- **플로우**:
  1. 사용자가 필드에서 포커스를 벗어난다 (blur 이벤트)
  2. 시스템이 해당 필드의 유효성을 검증한다
  3. 검증 실패 시:
     - 필드에 빨간색 테두리를 표시한다
     - 필드 하단에 구체적인 에러 메시지를 표시한다
     - 예: "작성자명은 2자 이상 10자 이하로 입력해주세요"
  4. 검증 성공 시:
     - 에러 표시를 제거한다
     - 녹색 체크 아이콘을 표시한다 (선택사항)
  5. 기본 플로우 2단계로 복귀한다

### 예외 플로우

#### EF-001: 유효성 검증 실패

- **예외 상황**: 필수 입력값이 누락되거나 형식이 잘못된 경우
- **발생 시점**: 기본 플로우 3단계
- **처리 방법**:
  1. 시스템이 "작성하기" 버튼 클릭을 무시한다
  2. 시스템이 첫 번째 오류가 있는 필드로 스크롤한다
  3. 시스템이 해당 필드에 포커스를 설정한다
  4. 시스템이 모든 오류 필드에 에러 메시지를 표시한다
  5. 사용자가 오류를 수정할 때까지 제출이 차단된다

#### EF-002: 네트워크 에러

- **예외 상황**: 네트워크 연결이 끊어지거나 API 호출이 실패한 경우
- **발생 시점**: 기본 플로우 4단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 에러 토스트 메시지를 표시한다: "네트워크 연결을 확인해주세요"
  4. 시스템이 사용자 입력 내용을 유지한다
  5. 사용자가 다시 제출을 시도할 수 있다

#### EF-003: 서버 에러 (5xx)

- **예외 상황**: 서버에서 예기치 않은 오류가 발생한 경우
- **발생 시점**: 기본 플로우 4단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 에러 토스트 메시지를 표시한다: "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요"
  4. 시스템이 에러를 콘솔에 로깅한다
  5. 사용자 입력 내용이 유지되어 재시도 가능하다

#### EF-004: 장소 정보 조회 실패

- **예외 상황**: 장소 ID로 장소 정보를 찾을 수 없는 경우
- **발생 시점**: 기본 플로우 1단계
- **처리 방법**:
  1. 시스템이 에러 페이지를 표시한다: "장소를 찾을 수 없습니다"
  2. 시스템이 "홈으로 돌아가기" 버튼을 제공한다
  3. 사용자가 버튼을 클릭하면 홈 페이지로 이동한다

### 비기능 요구사항

#### 성능

- 리뷰 작성 페이지 로딩: 1초 이내
- 리뷰 제출 후 API 응답: 500ms 이내 (p95)
- 장소 상세 페이지 리다이렉트: 즉시 (클라이언트 측 라우팅)

#### 보안

- 비밀번호는 평문으로 저장되지 않으며 bcrypt로 해싱된다
- 모든 입력값은 XSS 공격 방지를 위해 sanitize 처리된다
- 클라이언트와 서버 양측에서 유효성 검증이 수행된다
- SQL Injection 방지를 위해 파라미터화된 쿼리를 사용한다

#### 사용성

- 모든 필드에 명확한 레이블과 플레이스홀더가 제공된다
- 실시간 유효성 검증으로 즉각적인 피드백을 제공한다
- 에러 메시지는 구체적이고 이해하기 쉬워야 한다
- 별점은 시각적으로 선택 가능한 인터페이스로 제공된다
- 방문 날짜는 날짜 선택기(date picker)로 쉽게 입력 가능하다

#### 접근성

- 모든 폼 필드는 `<label>` 요소와 연결된다
- 필수 입력 필드는 `aria-required="true"` 속성을 가진다
- 에러 메시지는 `aria-live="polite"` 영역에 표시된다
- 키보드만으로 모든 폼 입력이 가능하다
- 포커스 스타일이 명확하게 표시된다

---

## UC-002: 리뷰 목록 조회

### 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **ID** | UC-002 |
| **이름** | 리뷰 목록 조회 |
| **우선순위** | P0 (Must Have) |
| **액터** | 일반 사용자 (비로그인) |
| **목적** | 특정 장소에 대한 다른 사용자들의 리뷰를 확인하여 방문 결정을 돕는다 |

### 사전 조건

- 사용자가 장소 상세 페이지에 접속한 상태여야 한다
- 네트워크 연결이 정상적으로 동작해야 한다
- 장소 ID가 유효해야 한다

### 사후 조건

- 해당 장소의 리뷰 목록이 화면에 표시된다
- 리뷰가 선택한 정렬 기준에 따라 정렬되어 표시된다
- 사용자는 무한 스크롤을 통해 추가 리뷰를 로드할 수 있다

### 기본 플로우

1. **장소 상세 페이지 진입**
   - 사용자가 홈 페이지에서 마커를 클릭하거나 검색 결과에서 장소를 선택한다
   - 시스템이 장소 상세 페이지(`/place/[placeId]`)로 이동한다

2. **초기 데이터 로딩**
   - 시스템이 스켈레톤 UI를 표시한다
   - 시스템이 다음 API를 병렬로 호출한다:
     - 장소 정보 조회 (`GET /api/places/:id`)
     - 리뷰 목록 조회 (`GET /api/places/:placeId/reviews?page=1&limit=20&sort=latest`)
   - 시스템이 로딩 중 상태를 표시한다

3. **장소 정보 표시**
   - 시스템이 장소 정보를 렌더링한다:
     - 장소명 (H1 제목)
     - 주소
     - 카테고리
     - 평균 평점 (별점 시각화)
     - 총 리뷰 수

4. **리뷰 목록 표시**
   - 시스템이 기본 정렬(최신순)로 첫 페이지(20개)의 리뷰를 표시한다
   - 각 리뷰 카드는 다음 정보를 포함한다:
     - 작성자명
     - 평점 (별점)
     - 리뷰 내용
     - 방문 날짜 (있는 경우)
     - 작성 날짜 (상대 시간: "2일 전", "3주 전" 등)
     - 수정/삭제 버튼 (항상 표시)

5. **정렬 옵션 제공**
   - 시스템이 정렬 드롭다운을 표시한다:
     - 최신순 (기본값)
     - 평점순 (높은 순)
   - 사용자가 정렬 기준을 변경할 수 있다

### 대체 플로우

#### AF-001: 리뷰가 없는 경우

- **분기점**: 기본 플로우 4단계
- **조건**: 해당 장소에 작성된 리뷰가 없는 경우
- **플로우**:
  1. 시스템이 빈 상태 UI를 표시한다
  2. 시스템이 안내 메시지를 표시한다: "아직 리뷰가 없습니다. 첫 번째 리뷰를 작성해보세요!"
  3. 시스템이 "리뷰 작성하기" CTA 버튼을 크게 표시한다
  4. 사용자가 버튼을 클릭하면 리뷰 작성 페이지로 이동한다

#### AF-002: 정렬 기준 변경

- **분기점**: 기본 플로우 5단계
- **조건**: 사용자가 정렬 드롭다운에서 다른 옵션을 선택한 경우
- **플로우**:
  1. 사용자가 정렬 드롭다운에서 "평점순"을 선택한다
  2. 시스템이 선택된 정렬 기준을 상태로 저장한다
  3. 시스템이 스켈레톤 UI를 표시한다
  4. 시스템이 새로운 정렬 기준으로 리뷰 목록 API를 호출한다:
     - `GET /api/places/:placeId/reviews?page=1&limit=20&sort=rating`
  5. 시스템이 정렬된 리뷰 목록을 렌더링한다
  6. 기본 플로우 4단계로 복귀한다

#### AF-003: 무한 스크롤 추가 로딩

- **분기점**: 기본 플로우 4단계 이후
- **조건**: 사용자가 리뷰 목록을 스크롤하여 하단에 도달한 경우
- **플로우**:
  1. 사용자가 페이지를 스크롤하여 하단에서 200px 이내로 접근한다
  2. 시스템이 다음 페이지가 있는지 확인한다 (`hasNext: true`)
  3. 시스템이 목록 하단에 로딩 스피너를 표시한다
  4. 시스템이 다음 페이지 API를 호출한다:
     - `GET /api/places/:placeId/reviews?page=2&limit=20&sort=latest`
  5. 시스템이 기존 목록에 새로운 리뷰를 추가로 렌더링한다
  6. 더 이상 다음 페이지가 없으면 로딩을 중지한다
  7. 기본 플로우 4단계로 복귀한다

### 예외 플로우

#### EF-001: 장소를 찾을 수 없는 경우

- **예외 상황**: 유효하지 않은 장소 ID로 접근한 경우
- **발생 시점**: 기본 플로우 2단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 에러 페이지를 표시한다
  3. 시스템이 에러 메시지를 표시한다: "장소를 찾을 수 없습니다"
  4. 시스템이 "홈으로 돌아가기" 버튼을 제공한다
  5. 사용자가 버튼을 클릭하면 홈 페이지로 이동한다

#### EF-002: 네트워크 에러

- **예외 상황**: API 호출 중 네트워크 오류가 발생한 경우
- **발생 시점**: 기본 플로우 2단계 또는 대체 플로우 AF-003
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 에러 토스트 메시지를 표시한다: "네트워크 연결을 확인해주세요"
  3. 시스템이 재시도 버튼을 제공한다
  4. 사용자가 재시도 버튼을 클릭하면 API 호출을 재시도한다
  5. 3회 재시도 실패 시, "새로고침" 버튼을 제공한다

#### EF-003: 서버 에러 (5xx)

- **예외 상황**: 서버에서 오류가 발생한 경우
- **발생 시점**: 기본 플로우 2단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 에러 토스트 메시지를 표시한다: "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요"
  3. 시스템이 에러를 콘솔에 로깅한다
  4. 시스템이 재시도 버튼을 제공한다

#### EF-004: 무한 스크롤 로딩 실패

- **예외 상황**: 추가 페이지 로딩 중 오류가 발생한 경우
- **발생 시점**: 대체 플로우 AF-003의 4단계
- **처리 방법**:
  1. 시스템이 로딩 스피너를 제거한다
  2. 시스템이 목록 하단에 에러 메시지를 표시한다: "추가 리뷰를 불러오지 못했습니다"
  3. 시스템이 "다시 시도" 버튼을 표시한다
  4. 사용자가 버튼을 클릭하면 해당 페이지 로딩을 재시도한다
  5. 기존에 로드된 리뷰는 그대로 유지된다

### 비기능 요구사항

#### 성능

- 장소 상세 페이지 초기 로딩: 2초 이내
- 리뷰 목록 API 응답: 500ms 이내 (p95)
- 무한 스크롤 추가 로딩: 300ms 이내
- 정렬 기준 변경 시 리렌더링: 즉시 (스켈레톤 UI 표시)
- React Query 캐싱: 5분 (staleTime)

#### 사용성

- 스켈레톤 UI로 로딩 상태를 시각적으로 표시한다
- 빈 상태 시 명확한 안내 메시지와 CTA를 제공한다
- 무한 스크롤은 자동으로 동작하며, 사용자 조작이 필요 없다
- 정렬 드롭다운은 현재 선택된 옵션을 명확히 표시한다
- 리뷰 작성 날짜는 상대 시간으로 표시하여 직관적으로 이해할 수 있다

#### 접근성

- 리뷰 목록은 시맨틱 HTML(`<article>`, `<section>`)로 마크업된다
- 별점은 `aria-label`로 "5점 만점에 4점" 형식으로 읽힌다
- 무한 스크롤 로딩 시 스크린 리더에 "추가 리뷰를 불러오는 중입니다" 안내가 제공된다
- 정렬 드롭다운은 키보드로 조작 가능하다

#### 확장성

- 리뷰 목록은 페이지네이션 방식으로 구현되어 대량의 리뷰를 처리할 수 있다
- 무한 스크롤은 페이지당 20개씩 로드하여 성능을 유지한다
- React Query의 `useInfiniteQuery` 훅을 사용하여 캐싱과 상태 관리를 최적화한다

---

## UC-003: 리뷰 수정

### 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **ID** | UC-003 |
| **이름** | 리뷰 수정 |
| **우선순위** | P1 (Should Have) |
| **액터** | 리뷰 작성자 |
| **목적** | 작성한 리뷰의 내용이나 평점을 수정하여 정확한 정보를 유지한다 |

### 사전 조건

- 사용자가 장소 상세 페이지에서 리뷰 목록을 확인하고 있어야 한다
- 수정하려는 리뷰가 데이터베이스에 존재해야 한다
- 네트워크 연결이 정상적으로 동작해야 한다

### 사후 조건

- 리뷰 내용이 수정된다
- 수정된 리뷰가 데이터베이스에 업데이트된다
- 평점이 변경된 경우, 장소의 평균 평점이 자동으로 재계산된다
- 리뷰의 `updated_at` 타임스탬프가 갱신된다
- 사용자는 장소 상세 페이지로 리다이렉트되어 수정된 리뷰를 확인할 수 있다

### 기본 플로우

1. **수정 버튼 클릭**
   - 사용자가 장소 상세 페이지의 리뷰 목록에서 특정 리뷰의 "수정" 버튼을 클릭한다
   - 시스템이 비밀번호 확인 모달을 표시한다

2. **비밀번호 인증**
   - 모달에 다음 요소가 표시된다:
     - 제목: "리뷰 수정"
     - 안내 메시지: "리뷰 작성 시 입력한 비밀번호를 입력해주세요"
     - 비밀번호 입력 필드 (type="password")
     - "확인" 버튼
     - "취소" 버튼
   - 사용자가 비밀번호를 입력한다
   - 사용자가 "확인" 버튼을 클릭한다

3. **비밀번호 검증**
   - 시스템이 "확인" 버튼을 비활성화하고 로딩 상태로 변경한다
   - 시스템이 비밀번호 검증 API를 호출한다:
     - 리뷰 ID와 입력된 비밀번호를 서버로 전송한다
   - 서버가 저장된 bcrypt 해시와 입력된 비밀번호를 비교한다
   - 비밀번호가 일치하는 경우, 서버가 성공 응답을 반환한다

4. **리뷰 수정 페이지 진입**
   - 시스템이 비밀번호 확인 모달을 닫는다
   - 시스템이 리뷰 수정 페이지(`/place/[placeId]/review/[reviewId]/edit`)로 이동한다
   - 시스템이 리뷰 ID로 기존 리뷰 정보를 조회한다
   - 시스템이 리뷰 수정 폼을 렌더링한다
   - 시스템이 기존 리뷰 내용을 폼 필드에 자동으로 입력한다:
     - 작성자명
     - 평점
     - 리뷰 내용
     - 방문 날짜 (있는 경우)

5. **리뷰 내용 수정**
   - 사용자가 폼 필드의 내용을 수정한다
   - 시스템이 실시간으로 입력값 유효성을 검증한다
   - 유효성 검증 규칙은 리뷰 작성과 동일하다:
     - 작성자명: 2-10자
     - 평점: 1-5
     - 리뷰 내용: 10-500자
     - 방문 날짜: 유효한 날짜 (선택사항)

6. **수정 내용 제출**
   - 사용자가 "수정하기" 버튼을 클릭한다
   - 시스템이 클라이언트 측 유효성 검증을 수행한다
   - 유효성 검증 통과 시, 버튼이 비활성화되고 "수정 중..." 로딩 상태로 변경된다

7. **서버 처리**
   - 시스템이 리뷰 수정 API(`PATCH /api/reviews/:id`)를 호출한다
   - 서버가 서버 측 유효성 검증을 수행한다
   - 서버가 XSS 방지를 위해 입력값을 sanitize 처리한다
   - 서버가 리뷰를 데이터베이스에서 업데이트한다
   - 서버가 `updated_at` 타임스탬프를 현재 시간으로 갱신한다
   - 평점이 변경된 경우, 데이터베이스 트리거가 장소의 평균 평점을 재계산한다

8. **결과 표시**
   - 시스템이 성공 토스트 메시지를 표시한다: "리뷰가 수정되었습니다"
   - 시스템이 장소 상세 페이지로 리다이렉트한다
   - 시스템이 수정된 리뷰를 목록에서 갱신하여 표시한다
   - React Query 캐시가 자동으로 무효화되어 최신 데이터를 표시한다

### 대체 플로우

#### AF-001: 비밀번호 불일치

- **분기점**: 기본 플로우 3단계
- **조건**: 입력한 비밀번호가 저장된 해시와 일치하지 않는 경우
- **플로우**:
  1. 서버가 401 Unauthorized 에러 응답을 반환한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 비밀번호 입력 필드에 빨간색 테두리를 표시한다
  4. 시스템이 필드 하단에 에러 메시지를 표시한다: "비밀번호가 일치하지 않습니다"
  5. 시스템이 비밀번호 입력 필드를 비우고 포커스를 설정한다
  6. 사용자가 올바른 비밀번호를 다시 입력할 수 있다
  7. 기본 플로우 2단계로 복귀한다

#### AF-002: 모달 취소

- **분기점**: 기본 플로우 2단계
- **조건**: 사용자가 비밀번호 확인 모달에서 "취소" 버튼을 클릭하거나 모달 외부를 클릭한 경우
- **플로우**:
  1. 시스템이 비밀번호 확인 모달을 닫는다
  2. 시스템이 장소 상세 페이지에 그대로 머문다
  3. 리뷰 수정이 취소되고 아무런 변경이 발생하지 않는다

#### AF-003: 수정 없이 제출

- **분기점**: 기본 플로우 5단계
- **조건**: 사용자가 아무 내용도 수정하지 않고 "수정하기" 버튼을 클릭한 경우
- **플로우**:
  1. 시스템이 변경사항이 없음을 감지한다
  2. 시스템이 API 호출을 스킵한다
  3. 시스템이 안내 토스트 메시지를 표시한다: "수정된 내용이 없습니다"
  4. 사용자가 계속 수정하거나 뒤로가기로 나갈 수 있다

### 예외 플로우

#### EF-001: 리뷰를 찾을 수 없는 경우

- **예외 상황**: 리뷰 ID로 리뷰를 조회할 수 없는 경우 (이미 삭제됨)
- **발생 시점**: 기본 플로우 4단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 에러 토스트 메시지를 표시한다: "리뷰를 찾을 수 없습니다"
  3. 시스템이 장소 상세 페이지로 리다이렉트한다
  4. 리뷰 목록이 갱신되어 삭제된 리뷰가 제거된다

#### EF-002: 유효성 검증 실패

- **예외 상황**: 수정된 내용이 유효성 검증을 통과하지 못한 경우
- **발생 시점**: 기본 플로우 6단계
- **처리 방법**:
  1. 시스템이 "수정하기" 버튼 클릭을 무시한다
  2. 시스템이 첫 번째 오류가 있는 필드로 스크롤한다
  3. 시스템이 해당 필드에 포커스를 설정한다
  4. 시스템이 모든 오류 필드에 에러 메시지를 표시한다
  5. 사용자가 오류를 수정할 때까지 제출이 차단된다

#### EF-003: 네트워크 에러

- **예외 상황**: API 호출 중 네트워크 오류가 발생한 경우
- **발생 시점**: 기본 플로우 3단계 또는 7단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 에러 토스트 메시지를 표시한다: "네트워크 연결을 확인해주세요"
  4. 시스템이 사용자 입력 내용을 유지한다
  5. 사용자가 다시 제출을 시도할 수 있다

#### EF-004: 서버 에러 (5xx)

- **예외 상황**: 서버에서 예기치 않은 오류가 발생한 경우
- **발생 시점**: 기본 플로우 7단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 에러 토스트 메시지를 표시한다: "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요"
  4. 시스템이 에러를 콘솔에 로깅한다
  5. 사용자 입력 내용이 유지되어 재시도 가능하다

### 비기능 요구사항

#### 보안

- 비밀번호 검증은 서버에서만 수행되며, 비밀번호 해시는 클라이언트로 전송되지 않는다
- 비밀번호 검증 실패 시, 구체적인 실패 이유(존재하지 않는 리뷰 vs 비밀번호 불일치)를 구분하지 않아 보안을 강화한다
- 비밀번호 입력 필드는 `type="password"`로 마스킹된다
- 모든 입력값은 XSS 공격 방지를 위해 sanitize 처리된다

#### 성능

- 비밀번호 검증 API 응답: 300ms 이내
- 리뷰 수정 페이지 로딩: 1초 이내
- 리뷰 수정 API 응답: 500ms 이내 (p95)
- React Query 캐시 무효화 및 갱신: 즉시

#### 사용성

- 비밀번호 확인 모달은 명확하고 간결하다
- 기존 리뷰 내용이 자동으로 입력되어 편리하다
- 실시간 유효성 검증으로 즉각적인 피드백을 제공한다
- 수정 완료 시 사용자를 장소 상세 페이지로 리다이렉트하여 수정 결과를 확인할 수 있다
- 비밀번호 불일치 시 명확한 에러 메시지를 제공한다

#### 접근성

- 비밀번호 확인 모달은 키보드로 조작 가능하다 (Tab, Enter, Escape)
- 모달 열림 시 포커스가 비밀번호 입력 필드로 자동 이동한다
- 모달 닫힘 시 포커스가 "수정" 버튼으로 복귀한다
- 에러 메시지는 `aria-live="polite"` 영역에 표시된다
- 비밀번호 입력 필드는 `aria-label` 또는 `<label>`과 연결된다

---

## UC-004: 리뷰 삭제

### 유스케이스 정보

| 항목 | 내용 |
|------|------|
| **ID** | UC-004 |
| **이름** | 리뷰 삭제 |
| **우선순위** | P1 (Should Have) |
| **액터** | 리뷰 작성자 |
| **목적** | 더 이상 필요 없는 리뷰를 삭제하여 정확한 정보만 유지한다 |

### 사전 조건

- 사용자가 장소 상세 페이지에서 리뷰 목록을 확인하고 있어야 한다
- 삭제하려는 리뷰가 데이터베이스에 존재해야 한다
- 네트워크 연결이 정상적으로 동작해야 한다

### 사후 조건

- 리뷰가 데이터베이스에서 영구적으로 삭제된다
- 장소의 평균 평점과 리뷰 수가 자동으로 재계산된다
- 삭제된 리뷰가 목록에서 즉시 제거된다
- 해당 장소의 리뷰가 0개가 된 경우, 지도에서 마커가 자동으로 제거된다
- React Query 캐시가 무효화되어 최신 상태를 반영한다

### 기본 플로우

1. **삭제 버튼 클릭**
   - 사용자가 장소 상세 페이지의 리뷰 목록에서 특정 리뷰의 "삭제" 버튼을 클릭한다
   - 시스템이 비밀번호 확인 모달을 표시한다

2. **비밀번호 인증**
   - 모달에 다음 요소가 표시된다:
     - 제목: "리뷰 삭제"
     - 안내 메시지: "리뷰 작성 시 입력한 비밀번호를 입력해주세요"
     - 비밀번호 입력 필드 (type="password")
     - "확인" 버튼
     - "취소" 버튼
   - 사용자가 비밀번호를 입력한다
   - 사용자가 "확인" 버튼을 클릭한다

3. **비밀번호 검증**
   - 시스템이 "확인" 버튼을 비활성화하고 로딩 상태로 변경한다
   - 시스템이 비밀번호 검증 API를 호출한다:
     - 리뷰 ID와 입력된 비밀번호를 서버로 전송한다
   - 서버가 저장된 bcrypt 해시와 입력된 비밀번호를 비교한다
   - 비밀번호가 일치하는 경우, 서버가 성공 응답을 반환한다

4. **삭제 확인**
   - 시스템이 비밀번호 확인 모달을 닫는다
   - 시스템이 삭제 확인 다이얼로그를 표시한다
   - 다이얼로그에 다음 요소가 표시된다:
     - 제목: "리뷰 삭제"
     - 경고 메시지: "리뷰를 삭제하시겠습니까? 삭제된 리뷰는 복구할 수 없습니다."
     - "삭제" 버튼 (빨간색, 강조)
     - "취소" 버튼

5. **삭제 실행**
   - 사용자가 "삭제" 버튼을 클릭한다
   - 시스템이 "삭제" 버튼을 비활성화하고 "삭제 중..." 로딩 상태로 변경한다
   - 시스템이 리뷰 삭제 API(`DELETE /api/reviews/:id`)를 호출한다
   - 요청 본문에 비밀번호를 포함한다 (재검증)

6. **서버 처리**
   - 서버가 비밀번호를 재검증한다
   - 서버가 리뷰를 데이터베이스에서 삭제한다
   - 서버가 데이터베이스 트리거를 통해 장소의 평균 평점과 리뷰 수를 재계산한다
   - 해당 장소의 리뷰 수가 0이 된 경우:
     - 서버가 장소 정보를 업데이트한다 (average_rating: 0, review_count: 0)

7. **결과 표시**
   - 시스템이 삭제 확인 다이얼로그를 닫는다
   - 시스템이 성공 토스트 메시지를 표시한다: "리뷰가 삭제되었습니다"
   - 시스템이 React Query 캐시를 무효화한다
   - 시스템이 리뷰 목록에서 삭제된 리뷰를 즉시 제거한다 (Optimistic Update)
   - 리뷰 수와 평균 평점이 자동으로 갱신된다

8. **마커 처리 (조건부)**
   - 삭제 후 해당 장소의 리뷰가 0개가 된 경우:
     - 시스템이 장소 상세 페이지를 닫는다 (또는 안내 메시지 표시)
     - 시스템이 홈 페이지로 리다이렉트한다
     - 지도에서 해당 장소의 마커가 자동으로 제거된다

### 대체 플로우

#### AF-001: 비밀번호 불일치

- **분기점**: 기본 플로우 3단계
- **조건**: 입력한 비밀번호가 저장된 해시와 일치하지 않는 경우
- **플로우**:
  1. 서버가 401 Unauthorized 에러 응답을 반환한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 비밀번호 입력 필드에 빨간색 테두리를 표시한다
  4. 시스템이 필드 하단에 에러 메시지를 표시한다: "비밀번호가 일치하지 않습니다"
  5. 시스템이 비밀번호 입력 필드를 비우고 포커스를 설정한다
  6. 사용자가 올바른 비밀번호를 다시 입력할 수 있다
  7. 기본 플로우 2단계로 복귀한다

#### AF-002: 비밀번호 확인 모달 취소

- **분기점**: 기본 플로우 2단계
- **조건**: 사용자가 비밀번호 확인 모달에서 "취소" 버튼을 클릭하거나 모달 외부를 클릭한 경우
- **플로우**:
  1. 시스템이 비밀번호 확인 모달을 닫는다
  2. 시스템이 장소 상세 페이지에 그대로 머문다
  3. 리뷰 삭제가 취소되고 아무런 변경이 발생하지 않는다

#### AF-003: 삭제 확인 다이얼로그 취소

- **분기점**: 기본 플로우 4단계
- **조건**: 사용자가 삭제 확인 다이얼로그에서 "취소" 버튼을 클릭한 경우
- **플로우**:
  1. 시스템이 삭제 확인 다이얼로그를 닫는다
  2. 시스템이 장소 상세 페이지에 그대로 머문다
  3. 리뷰 삭제가 취소되고 아무런 변경이 발생하지 않는다

#### AF-004: 마지막 리뷰 삭제

- **분기점**: 기본 플로우 6단계
- **조건**: 삭제하려는 리뷰가 해당 장소의 마지막 리뷰인 경우
- **플로우**:
  1. 서버가 리뷰를 삭제한다
  2. 서버가 장소의 평균 평점을 0으로, 리뷰 수를 0으로 업데이트한다
  3. 시스템이 성공 토스트 메시지를 표시한다: "리뷰가 삭제되었습니다"
  4. 시스템이 안내 토스트 메시지를 추가로 표시한다: "이 장소의 마지막 리뷰가 삭제되었습니다"
  5. 시스템이 홈 페이지로 리다이렉트한다
  6. 지도에서 해당 장소의 마커가 자동으로 제거된다
  7. React Query 캐시가 무효화되어 장소 목록이 갱신된다

### 예외 플로우

#### EF-001: 리뷰를 찾을 수 없는 경우

- **예외 상황**: 리뷰 ID로 리뷰를 조회할 수 없는 경우 (이미 삭제됨)
- **발생 시점**: 기본 플로우 6단계
- **처리 방법**:
  1. 서버가 404 Not Found 에러 응답을 반환한다
  2. 시스템이 다이얼로그를 닫는다
  3. 시스템이 에러 토스트 메시지를 표시한다: "이미 삭제된 리뷰입니다"
  4. 시스템이 React Query 캐시를 무효화한다
  5. 리뷰 목록이 갱신되어 삭제된 리뷰가 제거된다

#### EF-002: 네트워크 에러

- **예외 상황**: API 호출 중 네트워크 오류가 발생한 경우
- **발생 시점**: 기본 플로우 3단계 또는 5단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 다이얼로그를 닫는다
  4. 시스템이 에러 토스트 메시지를 표시한다: "네트워크 연결을 확인해주세요"
  5. 사용자가 다시 삭제를 시도할 수 있다

#### EF-003: 서버 에러 (5xx)

- **예외 상황**: 서버에서 예기치 않은 오류가 발생한 경우
- **발생 시점**: 기본 플로우 6단계
- **처리 방법**:
  1. 시스템이 로딩 상태를 해제한다
  2. 시스템이 버튼을 다시 활성화한다
  3. 시스템이 다이얼로그를 닫는다
  4. 시스템이 에러 토스트 메시지를 표시한다: "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요"
  5. 시스템이 에러를 콘솔에 로깅한다
  6. 사용자가 다시 삭제를 시도할 수 있다

#### EF-004: Optimistic Update 롤백

- **예외 상황**: 삭제 API 호출이 실패했으나 UI가 이미 업데이트된 경우
- **발생 시점**: 기본 플로우 7단계 이후
- **처리 방법**:
  1. 시스템이 Optimistic Update를 롤백한다
  2. 시스템이 삭제된 것처럼 보였던 리뷰를 다시 목록에 표시한다
  3. 시스템이 에러 토스트 메시지를 표시한다
  4. React Query 캐시가 이전 상태로 복구된다

### 비기능 요구사항

#### 보안

- 비밀번호 검증은 서버에서만 수행되며, 비밀번호 해시는 클라이언트로 전송되지 않는다
- 삭제 API 호출 시 비밀번호를 재검증하여 이중 보안을 적용한다
- 삭제는 영구적이며 복구할 수 없다는 점을 사용자에게 명확히 안내한다
- 비밀번호 입력 필드는 `type="password"`로 마스킹된다

#### 성능

- 비밀번호 검증 API 응답: 300ms 이내
- 리뷰 삭제 API 응답: 500ms 이내 (p95)
- Optimistic Update를 통해 UI가 즉시 반영된다
- React Query 캐시 무효화 및 갱신: 즉시
- 마커 제거 (조건부): 1초 이내

#### 사용성

- 비밀번호 확인 후 삭제 확인 다이얼로그를 추가로 표시하여 실수로 인한 삭제를 방지한다
- 삭제 버튼은 빨간색으로 강조하여 위험한 작업임을 시각적으로 표시한다
- 경고 메시지는 명확하고 이해하기 쉬워야 한다: "삭제된 리뷰는 복구할 수 없습니다"
- 삭제 완료 시 토스트 메시지로 사용자에게 피드백을 제공한다
- 마지막 리뷰 삭제 시 홈 페이지로 리다이렉트하여 빈 페이지를 방지한다

#### 접근성

- 비밀번호 확인 모달과 삭제 확인 다이얼로그는 키보드로 조작 가능하다
- 다이얼로그 열림 시 포커스가 "취소" 버튼으로 이동하여 실수를 방지한다
- "삭제" 버튼은 Tab 순서상 두 번째로 배치된다 (실수 방지)
- 경고 메시지는 `role="alertdialog"`로 마크업된다
- 에러 메시지는 `aria-live="assertive"` 영역에 표시된다 (삭제는 중요한 작업이므로)

#### 데이터 무결성

- 리뷰 삭제 시 장소의 평균 평점과 리뷰 수가 자동으로 재계산된다 (데이터베이스 트리거)
- 마지막 리뷰 삭제 시 장소 정보가 적절히 업데이트된다
- 트랜잭션을 사용하여 리뷰 삭제와 통계 갱신이 원자적으로 수행된다
- 삭제 실패 시 Optimistic Update가 롤백되어 데이터 일관성을 유지한다

---

## 유스케이스 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                        리뷰 관리 시스템                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────┐                                               │
│  │          │                                               │
│  │  일반    │───── UC-001: 리뷰 작성                         │
│  │  사용자  │                                               │
│  │          │───── UC-002: 리뷰 목록 조회                    │
│  │          │                                               │
│  └──────────┘                                               │
│       │                                                      │
│       │ (becomes)                                            │
│       │                                                      │
│       ▼                                                      │
│  ┌──────────┐                                               │
│  │          │                                               │
│  │  리뷰    │───── UC-003: 리뷰 수정 (비밀번호 인증 필요)      │
│  │  작성자  │                                               │
│  │          │───── UC-004: 리뷰 삭제 (비밀번호 인증 필요)      │
│  │          │                                               │
│  └──────────┘                                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 상태 전환 다이어그램

### 리뷰 생명주기

```
   ┌─────────────┐
   │  UC-001     │
   │  리뷰 작성   │
   └──────┬──────┘
          │
          ▼
   ┌─────────────┐
   │   리뷰 존재  │◄──────────────────┐
   │  (작성됨)    │                   │
   └──────┬──────┘                   │
          │                           │
          │                     ┌─────┴──────┐
          │                     │  UC-003    │
          │                     │  리뷰 수정  │
          │                     └────────────┘
          │
          │  UC-002
          │  리뷰 조회
          │  (항상 가능)
          │
          ▼
   ┌─────────────┐
   │  UC-004     │
   │  리뷰 삭제   │
   └──────┬──────┘
          │
          ▼
   ┌─────────────┐
   │  리뷰 제거   │
   │  (영구 삭제) │
   └─────────────┘
```

---

## 트레이서빌리티 매트릭스

| 유스케이스 | PRD 기능 요구사항 | 사용자 스토리 | API 엔드포인트 |
|-----------|------------------|--------------|---------------|
| UC-001: 리뷰 작성 | FR-REVIEW-001 | US-004 | POST /api/places/:placeId/reviews |
| UC-002: 리뷰 목록 조회 | FR-REVIEW-002 | US-001, US-002 | GET /api/places/:placeId/reviews |
| UC-003: 리뷰 수정 | FR-REVIEW-003 | US-005 | PATCH /api/reviews/:id |
| UC-004: 리뷰 삭제 | FR-REVIEW-004 | US-006 | DELETE /api/reviews/:id |

---

## 부록

### A. 용어 정의

| 용어 | 정의 |
|------|------|
| **비로그인 사용자** | 회원가입 또는 로그인 절차 없이 서비스를 이용하는 사용자 |
| **비밀번호 기반 인증** | 리뷰 작성 시 설정한 비밀번호로 수정/삭제 권한을 확인하는 방식 |
| **bcrypt 해싱** | 비밀번호를 안전하게 저장하기 위한 단방향 암호화 알고리즘 (salt rounds: 10) |
| **XSS (Cross-Site Scripting)** | 악의적인 스크립트를 삽입하는 공격, 입력값 sanitization으로 방지 |
| **Optimistic Update** | API 응답을 기다리지 않고 UI를 먼저 업데이트하여 빠른 사용자 경험을 제공하는 기법 |
| **무한 스크롤** | 페이지 하단 도달 시 자동으로 다음 페이지 데이터를 로드하는 UI 패턴 |
| **스켈레톤 UI** | 콘텐츠 로딩 중 표시되는 회색 플레이스홀더, 로딩 상태를 시각적으로 표현 |

### B. 참조 문서

- [사용자 플로우 문서](/docs/userflow.md) - 섹션 7.2: 리뷰 관리
- [PRD](/docs/prd.md) - 섹션 3.2.3: 리뷰 관리 기능 요구사항
- [API 명세](/docs/prd.md) - 섹션 7.2.2: 리뷰 API
- [데이터베이스 스키마](/docs/database.md) - reviews 테이블 정의

### C. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0.0 | 2025-10-21 | Development Team | 초안 작성 - 리뷰 관리 4개 유스케이스 정의 |

---

**문서 끝**
